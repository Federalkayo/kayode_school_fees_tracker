<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D.I.T Dashboard - School Fees Tracker</title>
  <link rel="icon" type="image/jpg" href="images/logo.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #e1bee7, #b2dfdb);
      color: #333;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background-color: #6a1b9a;
      color: white;
      padding: clamp(0.8rem, 2vw, 1rem) clamp(1rem, 3vw, 2rem);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      min-height: 60px;
      transition: background-color 0.3s;
    }
    header h1 {
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      margin: 0;
      line-height: 1;
      display: inline-block;
      vertical-align: middle;
    }
    nav {
      display: flex;
      align-items: center;
      gap: clamp(0.5rem, 2vw, 1rem);
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      padding: 0.5rem;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
    }
    nav a:hover {
      color: #f8bbd0;
    }
    .hamburger {
      display: none;
      font-size: clamp(1.2rem, 3vw, 1.5rem);
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    .container {
      padding: clamp(1rem, 4vw, 2rem);
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: clamp(1rem, 3vw, 2rem);
      margin-bottom: clamp(1rem, 3vw, 2rem);
      transition: background 0.3s;
    }
    .card h3 {
      margin-top: 0;
      color: #6a1b9a;
      font-size: clamp(1.2rem, 4vw, 1.5rem);
    }
    .card table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      overflow-x: auto;
      display: block;
    }
    .card th, .card td {
      border: 1px solid #ddd;
      padding: clamp(0.5rem, 2vw, 0.8rem);
      text-align: left;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
    }
    .card th {
      background: #f3e5f5;
      color: #4a148c;
      cursor: pointer;
    }
    .card th:hover {
      background: #e1bee7;
    }
    .card th.sorted-asc::after {
      content: ' ‚¨ÜÔ∏è';
    }
    .card th.sorted-desc::after {
      content: ' ‚¨áÔ∏è';
    }
    .actions button, #generatePDFBtn, #exportExcelBtn, #loadMoreBtn {
      padding: clamp(0.4rem, 1.5vw, 0.6rem) clamp(0.8rem, 2vw, 1rem);
      margin: 0.5rem 0.5rem 0.5rem 0;
      border: none;
      background: #ab47bc;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      position: relative;
      transition: background 0.3s;
    }
    .actions button:hover, #generatePDFBtn:hover, #exportExcelBtn:hover, #loadMoreBtn:hover {
      background: #8e24aa;
    }
    .delete-btn {
      background: #e57373;
    }
    .delete-btn:hover {
      background: #d32f2f;
    }
    .loader {
      display: none;
      width: clamp(16px, 2vw, 20px);
      height: clamp(16px, 2vw, 20px);
      border: 3px solid #fff;
      border-top: 3px solid #6a1b9a;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading .loader {
      display: block;
    }
    .loading span {
      visibility: hidden;
    }
    .summary {
      display: flex;
      gap: clamp(1rem, 3vw, 1.5rem);
      flex-wrap: wrap;
    }
    .summary-box {
      flex: 1 1 clamp(150px, 30vw, 200px);
      background: #f8bbd0;
      color: #880e4f;
      border-radius: 8px;
      padding: clamp(0.8rem, 2vw, 1rem) clamp(1rem, 2.5vw, 1.5rem);
      text-align: center;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      transition: background 0.3s, color 0.3s;
    }
    .summary-box h4 {
      margin-bottom: 0.5rem;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }
    .filter-section {
      margin: clamp(1rem, 3vw, 1.5rem) 0;
      display: flex;
      gap: clamp(0.5rem, 2vw, 1rem);
      flex-wrap: wrap;
    }
    .filter-section input, .filter-section select {
      padding: clamp(0.4rem, 1.5vw, 0.6rem);
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      flex: 1 1 clamp(120px, 40vw, 200px);
      transition: border-color 0.3s, background 0.3s, color 0.3s;
    }
    .filter-section input:focus, .filter-section select:focus {
      border-color: #ab47bc;
      outline: none;
    }
    .filter-section .clear-search {
      background: #e57373;
      color: white;
      border: none;
      padding: clamp(0.4rem, 1.5vw, 0.6rem);
      border-radius: 6px;
      cursor: pointer;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      transition: background 0.3s;
    }
    .filter-section .clear-search:hover {
      background: #d32f2f;
    }
    .hidden { display: none !important; }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      transition: background-color 0.3s;
    }
    .modal.show {
      display: block;
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: clamp(1rem, 3vw, 1.5rem);
      border-radius: 10px;
      width: clamp(260px, 80vw, 400px);
      max-width: 90%;
      transition: background 0.3s;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .close:hover {
      color: black;
    }
    .modal-content input {
      width: 100%;
      margin-bottom: 10px;
      padding: clamp(0.4rem, 1.5vw, 0.5rem);
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      transition: border-color 0.3s, background 0.3s, color 0.3s;
    }
    .modal-content input:focus {
      border-color: #ab47bc;
    }
    .modal-content button {
      width: 100%;
      padding: clamp(0.4rem, 1.5vw, 0.6rem);
      border: none;
      background: #ab47bc;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      position: relative;
      transition: background 0.3s;
    }
    .modal-content button:hover {
      background: #8e24aa;
    }
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .logo-container {
        flex-direction: row;
        align-items: center;
        width: 100%;
      }
      nav {
        display: none;
        flex-direction: column;
        width: 100%;
        background: #6a1b9a;
        padding: 1rem;
      }
      nav.open {
        display: flex;
      }
      .hamburger {
        display: block;
        align-self: flex-end;
      }
      .card table {
        min-width: 600px;
      }
      .filter-section {
        flex-direction: column;
      }
    }
    @media (max-width: 500px) {
      .summary-box {
        flex: 1 1 100%;
      }
      .card {
        padding: clamp(0.8rem, 2vw, 1rem);
      }
      .actions button, #generatePDFBtn, #exportExcelBtn, #loadMoreBtn {
        width: 100%;
        margin: 0.5rem 0;
      }
      .logo-container {
        flex-direction: row;
        align-items: center;
      }
      .homepage-logo {
        max-width: 35px;
        max-height: 35px;
      }
    }
    .logo-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: clamp(0.5rem, 1vw, 0.8rem);
      height: 100%;
    }
    .homepage-logo {
      max-width: 50px;
      height: auto;
      max-height: 50px;
      object-fit: contain;
      vertical-align: middle;
      transition: filter 0.3s;
    }
    @media (max-width: 768px) {
      .logo-container {
        flex-direction: row;
        align-items: center;
      }
      .homepage-logo {
        max-width: 40px;
        max-height: 40px;
      }
    }
    @media (max-width: 500px) {
      .homepage-logo {
        max-width: 35px;
        max-height: 35px;
      }
    }
    :root {
      --dark-primary-bg: #121212;
      --dark-secondary-bg: #1e1e1e;
      --dark-header-bg: #333;
      --dark-text-color: #e0e0e0;
      --dark-card-bg: #2a2a2a;
      --dark-accent-color: #bb86fc;
    }
    body.dark-mode {
      background: linear-gradient(to right, var(--dark-primary-bg), var(--dark-secondary-bg));
      color: var(--dark-text-color);
    }
    body.dark-mode header {
      background-color: var(--dark-header-bg);
    }
    body.dark-mode .card {
      background: var(--dark-card-bg);
    }
    body.dark-mode .card h3 {
      color: var(--dark-accent-color);
    }
    body.dark-mode .card th {
      background: #3c3c3c;
      color: var(--dark-text-color);
    }
    body.dark-mode .card th:hover {
      background: #4a4a4a;
    }
    body.dark-mode .actions button, 
    body.dark-mode #generatePDFBtn, 
    body.dark-mode #exportExcelBtn, 
    body.dark-mode #loadMoreBtn {
      background: var(--dark-accent-color);
    }
    body.dark-mode .actions button:hover, 
    body.dark-mode #generatePDFBtn:hover, 
    body.dark-mode #exportExcelBtn:hover, 
    body.dark-mode #loadMoreBtn:hover {
      background: #3700b3;
    }
    body.dark-mode .delete-btn {
      background: #cf6679;
    }
    body.dark-mode .delete-btn:hover {
      background: #b00020;
    }
    body.dark-mode .summary-box {
      background: #333;
      color: var(--dark-accent-color);
    }
    body.dark-mode .filter-section input, 
    body.dark-mode .filter-section select {
      background: #333;
      border-color: #555;
      color: var(--dark-text-color);
    }
    body.dark-mode .filter-section .clear-search {
      background: #cf6679;
    }
    body.dark-mode .filter-section .clear-search:hover {
      background: #b00020;
    }
    body.dark-mode .modal-content {
      background: var(--dark-card-bg);
    }
    body.dark-mode .close {
      color: #bbb;
    }
    body.dark-mode .close:hover {
      color: var(--dark-text-color);
    }
    body.dark-mode .modal-content input {
      background: #333;
      border-color: #555;
      color: var(--dark-text-color);
    }
    body.dark-mode .modal-content button {
      background: var(--dark-accent-color);
    }
    body.dark-mode .modal-content button:hover {
      background: #3700b3;
    }
    body.dark-mode .homepage-logo {
      filter: brightness(0.8) contrast(1.2);
    }
    body.dark-mode nav {
      background: var(--dark-header-bg);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      vertical-align: middle;
      margin-left: 1rem;
      flex-shrink: 0;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196f3;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.jpg" alt="D.I.T School Fees Tracker Logo" class="homepage-logo">
      <h1>Dashboard</h1>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Toggle navigation menu">
      <i class="fas fa-bars"></i>
    </button>
    <nav id="navMenu">
      <a href="index.html">Home</a>
      <a id="logoutBtn">Logout</a>
      <label class="switch" title="Toggle Dark Mode">
        <input type="checkbox" id="darkModeToggle" aria-checked="false" />
        <span class="slider round"></span>
      </label>
    </nav>
  </header>

  <div class="container">
    <div class="card">
      <h3 id="welcomeMessage">Welcome</h3>
      <p>Manage student payments, view balances, and update records.</p>
      <div class="actions" id="adminActions">
        <button id="openModalBtn">‚ûï <span>Add Payment</span><span class="loader"></span></button>
        <button id="generatePDFBtn">üìÑ <span>Export to PDF</span><span class="loader"></span></button>
        <button id="exportExcelBtn">üìä <span>Export to Excel</span><span class="loader"></span></button>
      </div>
    </div>

    <div class="card summary">
      <div class="summary-box">
        <h4>Total Students</h4>
        <p id="totalStudents">0</p>
      </div>
      <div class="summary-box">
        <h4>Total Paid</h4>
        <p id="totalPaid">‚Ç¶0</p>
      </div>
      <div class="summary-box">
        <h4>Total Balance</h4>
        <p id="totalBalance">‚Ç¶0</p>
      </div>
    </div>

    <div class="card filter-section">
      <input id="searchInput" type="text" placeholder="Search by name, matric, department, or class..." aria-label="Search payments" />
      <select id="departmentFilter" aria-label="Filter by department">
        <option value="">All Departments</option>
      </select>
      <select id="sessionFilter" aria-label="Filter by session">
        <option value="">All Sessions</option>
      </select>
      <select id="classFilter" aria-label="Filter by class">
        <option value="">All Classes</option>
      </select>
      <button class="clear-search" id="clearSearch">Clear</button>
    </div>

    <div class="card" id="tableSection">
      <h3>Student Payment Records</h3>
      <table>
        <thead>
          <tr>
            <th data-sort="name">Name <i class="fas fa-sort"></i></th>
            <th data-sort="matricNumber">Matric <i class="fas fa-sort"></i></th>
            <th data-sort="department">Department <i class="fas fa-sort"></i></th>
            <th data-sort="studentClass">Class <i class="fas fa-sort"></i></th>
            <th data-sort="session">Session <i class="fas fa-sort"></i></th>
            <th data-sort="amountPaid">Amount Paid <i class="fas fa-sort"></i></th>
            <th data-sort="balance">Balance <i class="fas fa-sort"></i></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="paymentsTableBody"></tbody>
      </table>
      <button id="loadMoreBtn" style="margin-top: 1rem;">Load More</button>
    </div>

    <div class="card">
      <canvas id="summaryChart"></canvas>
    </div>
  </div>

  <div class="modal" id="paymentModal">
    <div class="modal-content">
      <span class="close" id="closeModal">√ó</span>
      <h3 id="modalTitle">Add Payment</h3>
      <form id="paymentForm">
        <input type="text" id="studentName" placeholder="Full Name" required aria-label="Student Name" />
        <input type="text" id="matricNumber" placeholder="Matric Number" required aria-label="Matric Number" />
        <input type="text" id="department" placeholder="Department" required aria-label="Department" />
        <input type="text" id="studentClass" placeholder="Class (e.g., ND1, ND2, HND1)" required aria-label="Class" />
        <input type="text" id="session" placeholder="Academic Session (e.g., 2024/2025)" required aria-label="Academic Session" />
        <input type="number" id="amountPaid" placeholder="Amount Paid" required step="0.01" min="0" aria-label="Amount Paid" />
        <input type="number" id="balance" placeholder="Balance" readonly aria-label="Balance" />
        <button type="submit" id="submitPayment"><span>Add Payment</span><span class="loader"></span></button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendEmailVerification, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, updateDoc, deleteDoc, getDocs, query, orderBy, limit, startAfter, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD_facL7wwsMTXfrs7gzUrxtBZn3rIoew",
      authDomain: "kayode-school-fees-tracker.firebaseapp.com",
      projectId: "kayode-school-fees-tracker",
      storageBucket: "kayode-school-fees-tracker.appspot.com",
      messagingSenderId: "401342223859",
      appId: "1:401342223859:web:255a87636c3cbedbc5ee86"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let hasRedirected = false;
    function checkAuthState() {
      onAuthStateChanged(auth, async user => {
        if (hasRedirected) return;
        if (!user) {
          hasRedirected = true;
          alert("Please log in to access the dashboard.");
          window.location.href = "login.html";
          return;
        }
        if (!user.emailVerified && !user.providerData.some(p => p.providerId === 'google.com')) {
          hasRedirected = true;
          await sendEmailVerification(user);
          alert("Please verify your email address. A verification link has been sent to your email.");
          signOut(auth);
          window.location.href = "login.html";
          return;
        }
        const displayName = user.displayName || user.email;
        document.getElementById("welcomeMessage").textContent = `Welcome, ${displayName}`;
        console.log("Auth state checked, fetching payments...");
        fetchPayments(true);
      });
    }

    setPersistence(auth, browserLocalPersistence)
      .then(() => console.log("Persistence set to LOCAL"))
      .catch(error => console.error("Error setting persistence:", error));

    setTimeout(checkAuthState, 1000);

    const modal = document.getElementById("paymentModal");
    const modalTitle = document.getElementById("modalTitle");
    const openModalBtn = document.getElementById("openModalBtn");
    const closeModal = document.getElementById("closeModal");
    const paymentForm = document.getElementById("paymentForm");
    const submitPayment = document.getElementById("submitPayment");
    const paymentsTableBody = document.getElementById("paymentsTableBody");
    const searchInput = document.getElementById("searchInput");
    const departmentFilter = document.getElementById("departmentFilter");
    const sessionFilter = document.getElementById("sessionFilter");
    const classFilter = document.getElementById("classFilter");
    const clearSearch = document.getElementById("clearSearch");
    const totalStudents = document.getElementById("totalStudents");
    const totalPaid = document.getElementById("totalPaid");
    const totalBalance = document.getElementById("totalBalance");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    let paymentsData = [];
    let currentSort = { field: "name", direction: "asc" };
    let lastDoc = null;
    let editPaymentId = null;
    const pageSize = 10;

    // Define school fees for ND1 and ND2
    const schoolFees = {
      "ND1": 120000,
      "ND2": 165000
    };

    // Function to update balance based on class and amount paid
    function updateBalance() {
      const studentClass = document.getElementById("studentClass").value.trim().toUpperCase();
      const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
      const balanceInput = document.getElementById("balance");
      let totalFees = 0;

      if (studentClass in schoolFees) {
        totalFees = schoolFees[studentClass];
        const balance = Math.max(0, totalFees - amountPaid);
        balanceInput.value = balance.toFixed(2);
      } else {
        balanceInput.value = "";
      }
    }

    // Add event listeners for automatic balance update
    document.getElementById("studentClass").addEventListener("input", updateBalance);
    document.getElementById("amountPaid").addEventListener("input", updateBalance);

    openModalBtn.onclick = () => {
      modalTitle.textContent = "Add Payment";
      submitPayment.querySelector("span").textContent = "Add Payment";
      document.getElementById("studentName").value = "";
      document.getElementById("matricNumber").value = "";
      document.getElementById("department").value = "";
      document.getElementById("studentClass").value = "";
      document.getElementById("session").value = "";
      document.getElementById("amountPaid").value = "";
      document.getElementById("balance").value = "";
      editPaymentId = null;
      modal.classList.add("show");
      modal.style.display = "block";
    };

    closeModal.onclick = () => {
      modal.style.display = "none";
      modal.classList.remove("show");
    };

    window.onclick = e => {
      if (e.target === modal) {
        modal.style.display = "none";
        modal.classList.remove("show");
      }
    };

    paymentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitPayment.classList.add("loading");
      submitPayment.disabled = true;

      const studentName = document.getElementById("studentName").value.trim();
      const matricNumber = document.getElementById("matricNumber").value.trim();
      const department = document.getElementById("department").value.trim();
      const studentClass = document.getElementById("studentClass").value.trim().toUpperCase();
      const session = document.getElementById("session").value.trim();
      const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
      const balance = parseFloat(document.getElementById("balance").value) || 0;

      console.log("Attempting to add payment:", { studentName, matricNumber, department, studentClass, session, amountPaid, balance });

      if (!studentName || !matricNumber || !department || !studentClass || !session || isNaN(amountPaid) || isNaN(balance)) {
        alert("Please fill all fields correctly.");
        submitPayment.classList.remove("loading");
        submitPayment.disabled = false;
        return;
      }

      if (amountPaid < 0 || balance < 0) {
        alert("Amount Paid and Balance cannot be negative.");
        submitPayment.classList.remove("loading");
        submitPayment.disabled = false;
        return;
      }

      if (!(studentClass in schoolFees)) {
        alert("Invalid class. Please enter ND1 or ND2.");
        submitPayment.classList.remove("loading");
        submitPayment.disabled = false;
        return;
      }

      try {
        if (editPaymentId) {
          await updateDoc(doc(db, "payments", editPaymentId), {
            name: studentName,
            matricNumber,
            department,
            studentClass,
            session,
            amountPaid,
            balance,
            updatedAt: new Date()
          });
          console.log("Payment updated:", editPaymentId);
          alert("Payment updated successfully.");
        } else {
          const docRef = await addDoc(collection(db, "payments"), {
            name: studentName,
            matricNumber,
            department,
            studentClass,
            session,
            amountPaid,
            balance,
            createdAt: serverTimestamp()
          });
          console.log("Payment added with ID:", docRef.id);
          alert("Payment added successfully.");
        }
        modal.style.display = "none";
        modal.classList.remove("show");
        searchInput.value = "";
        departmentFilter.value = "";
        sessionFilter.value = "";
        classFilter.value = "";
        console.log("Fetching payments after add/edit...");
        fetchPayments(true);
        paymentForm.reset();
        editPaymentId = null;
      } catch (err) {
        console.error("Error adding/updating payment:", err);
        alert(`Error: ${err.message || "Something went wrong"}`);
      } finally {
        submitPayment.classList.remove("loading");
        submitPayment.disabled = false;
      }
    });

    async function fetchPayments(reset = false) {
      if (reset) {
        paymentsData = [];
        lastDoc = null;
        loadMoreBtn.style.display = "block";
      }

      paymentsTableBody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
      const q = query(
        collection(db, "payments"),
        orderBy(currentSort.field, currentSort.direction),
        limit(pageSize)
      );

      try {
        console.log("Fetching payments with query:", {
          sortField: currentSort.field,
          sortDirection: currentSort.direction,
          pageSize,
          startAfter: lastDoc ? lastDoc.id : null
        });
        const querySnapshot = await getDocs(q);
        const departments = new Set();
        const sessions = new Set();
        const classes = new Set();
        const newData = [];

        querySnapshot.forEach(doc => {
          const data = { id: doc.id, ...doc.data() };
          newData.push(data);
          departments.add(data.department);
          sessions.add(data.session);
          classes.add(data.studentClass);
          console.log("Fetched payment:", data);
        });

        lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
        if (querySnapshot.empty || newData.length < pageSize) {
          loadMoreBtn.style.display = "none";
        }

        paymentsData = reset ? newData : [...paymentsData, ...newData];
        console.log("Updated paymentsData:", paymentsData);

        departmentFilter.innerHTML = '<option value="">All Departments</option>';
        departments.forEach(dept => {
          const option = document.createElement("option");
          option.value = dept;
          option.textContent = dept;
          departmentFilter.appendChild(option);
        });

        sessionFilter.innerHTML = '<option value="">All Sessions</option>';
        sessions.forEach(ses => {
          const option = document.createElement("option");
          option.value = ses;
          option.textContent = ses;
          sessionFilter.appendChild(option);
        });

        classFilter.innerHTML = '<option value="">All Classes</option>';
        classes.forEach(cls => {
          const option = document.createElement("option");
          option.value = cls;
          option.textContent = cls;
          classFilter.appendChild(option);
        });

        renderTable();
        updateSummary();
        updateChart();
      } catch (err) {
        console.error("Error fetching payments:", err);
        alert(`Error: ${err.message || "Failed to fetch payments"}`);
        paymentsTableBody.innerHTML = '<tr><td colspan="8">Error loading data</td></tr>';
      }
    }

    function renderTable() {
      let filteredData = paymentsData;
      const searchValue = searchInput.value.toLowerCase();
      const selectedDepartment = departmentFilter.value;
      const selectedSession = sessionFilter.value;
      const selectedClass = classFilter.value;

      if (searchValue) {
        filteredData = filteredData.filter(payment =>
          payment.name.toLowerCase().includes(searchValue) ||
          payment.matricNumber.toLowerCase().includes(searchValue) ||
          payment.department.toLowerCase().includes(searchValue) ||
          payment.studentClass.toLowerCase().includes(searchValue) ||
          payment.session.toLowerCase().includes(searchValue)
        );
      }
      if (selectedDepartment) {
        filteredData = filteredData.filter(payment => payment.department === selectedDepartment);
      }
      if (selectedSession) {
        filteredData = filteredData.filter(payment => payment.session === selectedSession);
      }
      if (selectedClass) {
        filteredData = filteredData.filter(payment => payment.studentClass === selectedClass);
      }

      console.log("Rendering table with filtered data:", filteredData);
      paymentsTableBody.innerHTML = "";
      filteredData.forEach(payment => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${payment.name}</td>
          <td>${payment.matricNumber}</td>
          <td>${payment.department}</td>
          <td>${payment.studentClass}</td>
          <td>${payment.session}</td>
          <td>‚Ç¶${payment.amountPaid.toLocaleString()}</td>
          <td>‚Ç¶${payment.balance.toLocaleString()}</td>
          <td>
            <button class="action-btn" data-id="${payment.id}">Edit</button>
            <button class="delete-btn" data-id="${payment.id}">üóë Delete</button>
          </td>
        `;
        paymentsTableBody.appendChild(row);
      });
    }

    function updateSummary() {
      totalStudents.textContent = paymentsData.length;
      const paid = paymentsData.reduce((sum, payment) => sum + payment.amountPaid, 0);
      const balance = paymentsData.reduce((sum, payment) => sum + payment.balance, 0);
      totalPaid.textContent = `‚Ç¶${paid.toLocaleString()}`;
      totalBalance.textContent = `‚Ç¶${balance.toLocaleString()}`;
      console.log("Summary updated:", { totalStudents: paymentsData.length, totalPaid: paid, totalBalance: balance });
    }

    let chartInstance = null;
    function updateChart() {
      const ctx = document.getElementById("summaryChart").getContext("2d");
      const departmentSums = paymentsData.reduce((acc, payment) => {
        acc[payment.department] = (acc[payment.department] || 0) + payment.amountPaid;
        return acc;
      }, {});

      const labels = Object.keys(departmentSums);
      const data = Object.values(departmentSums);

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Amount Paid by Department',
            data,
            backgroundColor: '#ab47bc',
            borderColor: '#6a1b9a',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          animation: false
        }
      });
      console.log("Chart updated with data:", { labels, data });
    }

    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const field = th.dataset.sort;
        if (currentSort.field === field) {
          currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          currentSort.field = field;
          currentSort.direction = "asc";
        }
        document.querySelectorAll("th").forEach(header => {
          header.classList.remove("sorted-asc", "sorted-desc");
        });
        th.classList.add(`sorted-${currentSort.direction}`);
        console.log("Sorting changed:", currentSort);
        fetchPayments(true);
      });
    });

    paymentsTableBody.addEventListener("click", async e => {
      if (e.target.classList.contains("action-btn")) {
        const paymentId = e.target.dataset.id;
        const payment = paymentsData.find(p => p.id === paymentId);
        if (payment) {
          modalTitle.textContent = "Update Payment";
          submitPayment.querySelector("span").textContent = "Update Payment";
          document.getElementById("studentName").value = payment.name;
          document.getElementById("matricNumber").value = payment.matricNumber;
          document.getElementById("department").value = payment.department;
          document.getElementById("studentClass").value = payment.studentClass;
          document.getElementById("session").value = payment.session;
          document.getElementById("amountPaid").value = payment.amountPaid;
          document.getElementById("balance").value = payment.balance;
          editPaymentId = paymentId;
          modal.classList.add("show");
          modal.style.display = "block";
          updateBalance(); // Ensure balance is updated when editing
          console.log("Editing payment:", payment);
        }
      } else if (e.target.classList.contains("delete-btn")) {
        const paymentId = e.target.dataset.id;
        if (confirm("Are you sure you want to delete this payment?")) {
          try {
            await deleteDoc(doc(db, "payments", paymentId));
            console.log("Payment deleted:", paymentId);
            alert("Payment deleted successfully.");
            fetchPayments(true);
          } catch (err) {
            console.error("Error deleting payment:", err);
            alert(`Error: ${err.message || "Failed to delete payment"}`);
          }
        }
      }
    });

    searchInput.addEventListener("input", () => {
      console.log("Search input changed:", searchInput.value);
      renderTable();
    });
    departmentFilter.addEventListener("change", () => {
      console.log("Department filter changed:", departmentFilter.value);
      renderTable();
    });
    sessionFilter.addEventListener("change", () => {
      console.log("Session filter changed:", sessionFilter.value);
      renderTable();
    });
    classFilter.addEventListener("change", () => {
      console.log("Class filter changed:", classFilter.value);
      renderTable();
    });
    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      departmentFilter.value = "";
      sessionFilter.value = "";
      classFilter.value = "";
      console.log("Filters cleared");
      renderTable();
    });

    loadMoreBtn.addEventListener("click", () => {
      console.log("Load more clicked");
      fetchPayments();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
        console.log("User logged out");
        alert("Logged out successfully.");
        window.location.href = "login.html";
      }).catch(error => {
        console.error("Logout error:", error);
        alert(`Error: ${error.message || "Logout failed"}`);
      });
    });

    document.getElementById("generatePDFBtn").addEventListener("click", () => {
      console.log("Generating PDF...");
      const tableCard = document.getElementById("tableSection");
      html2canvas(tableCard).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("payment_records.pdf");
        console.log("PDF generated successfully");
      }).catch(err => {
        console.error("PDF generation error:", err);
        alert("Error generating PDF");
      });
    });

    document.getElementById("exportExcelBtn").addEventListener("click", () => {
      console.log("Exporting to Excel...");
      const ws = XLSX.utils.json_to_sheet(paymentsData.map(payment => ({
        Name: payment.name,
        "Matric Number": payment.matricNumber,
        Department: payment.department,
        Class: payment.studentClass,
        Session: payment.session,
        "Amount Paid": payment.amountPaid,
        Balance: payment.balance
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Payments");
      XLSX.write(wb, "payment_records.xlsx");
      console.log("Excel exported successfully");
    });

    const hamburger = document.getElementById("hamburger");
    const navMenu = document.getElementById("navMenu");
    hamburger.addEventListener("click", () => {
      navMenu.classList.toggle("open");
      const icon = hamburger.querySelector("i");
      icon.classList.toggle("fa-bars");
      icon.classList.toggle("fa-times");
      console.log("Hamburger menu toggled:", navMenu.classList.contains("open") ? "open" : "closed");
    });

    // Dark Mode Toggle Logic
    const toggle = document.getElementById("darkModeToggle");
    function initializeDarkMode() {
      const darkMode = localStorage.getItem("darkMode");
      if (darkMode === "enabled") {
        document.body.classList.add("dark-mode");
        toggle.checked = true;
        toggle.setAttribute("aria-checked", "true");
      } else {
        document.body.classList.remove("dark-mode");
        toggle.checked = false;
        toggle.setAttribute("aria-checked", "false");
      }
    }

    toggle.addEventListener("change", () => {
      if (toggle.checked) {
        document.body.classList.add("dark-mode");
        localStorage.setItem("darkMode", "enabled");
        toggle.setAttribute("aria-checked", "true");
      } else {
        document.body.classList.remove("dark-mode");
        localStorage.setItem("darkMode", "disabled");
        toggle.setAttribute("aria-checked", "false");
      }
      console.log("Dark mode toggled:", document.body.classList.contains("dark-mode") ? "enabled" : "disabled");
    });

    // Initialize dark mode on page load
    initializeDarkMode();
  </script>
</body>
</html>